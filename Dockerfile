FROM --platform=$BUILDPLATFORM sbtscala/scala-sbt:eclipse-temurin-17.0.14_7_1.10.10_2.12.20 AS build

WORKDIR /build/
COPY build.sbt /build/
COPY project /build/project/

RUN sbt update

COPY src /build/src
RUN sbt assembly

FROM apache/spark:3.5.5-scala2.12-java17-ubuntu

#This jar file is generated by sbt assembly
COPY --from=build /build/target/scala-2.12/Slacken-assembly-1.1.0.jar /opt/slacken/target/scala-2.12/
COPY slacken.sh /opt/slacken/
COPY log4j.properties /opt/slacken/

#A writable directory for scratch space. Supply to docker with e.g. -v /fast/spark:/scratch:rw
USER root
RUN mkdir /scratch
RUN chown spark:spark /scratch
USER spark
ENV SLACKEN_TMP /scratch

ENV SLACKEN_HOME /opt/slacken

#Consider also setting SLACKEN_MEMORY while running, e.g. with -e SLACKEN_MEMORY=32g (more is better).

#The web interface may be accessed on this port while Slacken is running.
#Run with -p 4040:4040
ENV SPARK_LOCAL_IP 0.0.0.0
EXPOSE 4040

ENTRYPOINT ["/opt/slacken/slacken.sh"]
CMD ["--help"]
